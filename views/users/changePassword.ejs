<% var loggedin = true; %> <!-- You can set it to true or false based on your logic -->
<%- include('../layouts/user-header.ejs', { loggedin: loggedin, user: user }) %>
<%- include('../layouts/user-sidebar.ejs') %>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Password</title>
    
</head>
<body>
    <div id="changePasswordContainer">
        <h1>Change Password</h1>
        <form action="/change-password" method="POST" id="changePasswordForm">
            <div>
                <label for="currentPassword">Current Password:</label>
                <input type="password" id="currentPassword" name="currentPassword" required>
                <div id="currentPasswordError" class="error-message"></div>
            </div>
            <div>
                <label for="newPassword">New Password:</label>
                <input type="password" id="newPassword" name="newPassword" required>
            </div>
            <div>
                <label for="confirmPassword">Confirm Password:</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required>
            </div>
            <button type="submit" id="changePasswordButton" disabled>Change Password</button>
        </form>
        <div class="checkbox-group">
            <label>
                <input type="checkbox" name="lowercase" id="lowercase"> Contains lowercase letter
            </label>
            <label>
                <input type="checkbox" name="special" id="special"> Contains special character
            </label>
            <label>
                <input type="checkbox" name="length" id="length"> Minimum 8 characters
            </label>
        </div>
        <div id="error" class="error-message"></div>
        <div id="warning" class="warning-message"></div>
    </div>

    <script>
        const passwordInput = document.getElementById('newPassword');
        const lowercaseCheckbox = document.getElementById('lowercase');
        const specialCheckbox = document.getElementById('special');
        const lengthCheckbox = document.getElementById('length');
        const errorDiv = document.getElementById('error');
        const warningDiv = document.getElementById('warning');
        const changePasswordButton = document.getElementById('changePasswordButton');
        const currentPasswordInput = document.getElementById('currentPassword');
        const currentPasswordError = document.getElementById('currentPasswordError');

        // Function to check if new password meets criteria
        function checkPasswordCriteria(password) {
            const hasLowercase = /[a-z]/.test(password);
            const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
            const hasLength = password.length >= 8;

            lowercaseCheckbox.checked = hasLowercase;
            specialCheckbox.checked = hasSpecial;
            lengthCheckbox.checked = hasLength;

            if (!hasLowercase || !hasSpecial || !hasLength) {
                errorDiv.style.display = 'block';
                errorDiv.innerHTML = 'Password must contain at least one lowercase letter, one special character, and be at least 8 characters long.';
                changePasswordButton.disabled = true;
            } else {
                errorDiv.style.display = 'none';
                changePasswordButton.disabled = false;
            }
        }

        // Check password criteria on input
        passwordInput.addEventListener('input', function () {
            checkPasswordCriteria(passwordInput.value);
        });

        // Check password criteria on submit
        document.getElementById('changePasswordForm').addEventListener('submit', function (e) {
            const password = passwordInput.value;
            checkPasswordCriteria(password);

            if (!changePasswordButton.disabled) {
                // Password meets criteria, proceed
                errorDiv.style.display = 'none';
                
                const currentPassword = currentPasswordInput.value;
                if (currentPassword === 'password123') {
                    e.preventDefault(); // Prevent form submission
                    currentPasswordError.style.display = 'block';
                    currentPasswordError.innerHTML = 'Incorrect current password.';
                } else {
                    currentPasswordError.style.display = 'none';
                    // Redirect to user profile page
                    window.location.href = '/userprofile'; 
                }
            } else {
                e.preventDefault(); // Prevent form submission
            }
        });

        // Initially hide the error and warning messages
        errorDiv.style.display = 'none';
        warningDiv.style.display = 'none';
        currentPasswordError.style.display = 'none';
    </script>
</body>
</html>
